#!/bin/bash

title='

█▄▄▄▄ ████▄ ███   ████▄  ▄  █ ▄███▄   █    █ ▄▄
█  ▄▀ █   █ █  █  █   █ █   █ █▀   ▀  █    █   █
█▀▀▌  █   █ █ ▀ ▄ █   █ ██▀▀█ ██▄▄    █    █▀▀▀
█  █  ▀████ █  ▄▀ ▀████ █   █ █▄   ▄▀ ███▄ █
  █         ███            █  ▀███▀       ▀ █
 ▀                        ▀                  ▀
'

bb8='⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠐⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣀⣸⣀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠴⠾⠿⠿⠿⠛⠋⠁⠀⣠⣴⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣄⣀⣀⣀⣀⣀⣤⣤⣴⠶⠛⢋⣡⣴⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣤⣬⣉⣉⣉⣉⡟⣁⠀⠀⠈⠙⣿⣿⣿⣿⣿⣿⣿⣧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⡀⠛⠀⠀⠀⠀⣿⣿⠋⠉⠙⢿⣿⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣷⣄⡀⠀⣀⣴⣿⣇⠀⠀⠀⣸⣿⣿⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣤⡴⠟⠛⣁⠤⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠿⠛⠛⣉⣡⠤⠒⠋⠁⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠬⣉⣉⣉⣉⣠⠤⠤⠤⠴⠒⠚⠉⠁⠀⠀⠀⣤⣾⣿⣿⣿⣶⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣶⣦⣤⣤⣤⣤⣤⣤⣤⣤⣴⣶⣶⣦⡀⠀⠈⠙⢿⣿⠋⠛⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⠿⠛⠉⠉⠉⠉⠉⠛⠿⣿⣿⣿⣿⣿⣿⣿⣦⣄⠀⠀⠀⠀⠀⢿⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠟⠁⢀⣠⣤⣤⣤⣄⡀⠀⠀⠈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣶⣤⣀⠀⠀⠀⠉⠉⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⣴⣿⣿⣿⣿⣿⠟⠀⢀⡀⠀⠀⠙⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣦⣤⣀⣀⣀⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠇⠀⠀⢹⣿⣿⣿⣿⣿⣤⣴⣿⣿⡄⠀⠀⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⠀⣿⣦⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠟⠛⠻⠿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣧⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⢿⣿⡿⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⠟⠋⠀⠀⠀⠀⠀⠀⠘⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⡀⠸⣿⡿⢿⣿⣿⣿⣿⣿⣄⠀⠈⠁⠀⠀⢀⣿⣿⣿⣿⣿⣿⣿⠟⠁⠀⠀⠀⣠⣤⣶⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣧⠀⠙⠀⢰⣿⣿⣿⣿⣿⣿⡷⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⡟⠁⠀⠀⣠⡀⠀⢻⣿⣿⣿⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣷⡀⠀⠘⠛⠿⠿⠿⠛⠉⠀⠀⠀⢀⣾⣿⣿⣿⣿⣿⠏⠀⠀⢀⣴⣿⣷⣤⣼⣿⣿⣿⣠⠆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣦⣄⡀⠀⠀⠀⠀⠀⠀⣠⣴⣿⣿⣿⣿⣿⣿⡏⠀⠀⢀⣾⣿⣿⣿⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣷⣶⣶⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠘⠛⠛⣹⣿⣿⣿⣿⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⢠⣶⣿⣿⣿⡿⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠻⢿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠀⠀⠈⠻⠿⠛⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠙⠛⠛⠛⠛⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀'


mainloop=0
timestamp=$(date "+%Y-%m-%d %H:%M:%S")

# Function to print banner
show_banner() {
    echo "$title"
    echo "$bb8"
}

# Function to determine distro
det_release() {
    distro=$(lsb_release -i | cut -f2-)
}

# Main Functions
check_installed() {
    if command -v "$1" &> /dev/null; then
        return 0
    else
	return 1
    fi
}

apt_update() {
    echo "📦 Running APT Repository update..."
    sudo apt update -y
    if [ $? -eq 0 ]; then
        echo "✅ Updated repositories successfully on $distro."
    else
	echo "❌ Failed to update repositories on $distro. Exit code: $?"
    fi
}

apt_upgrade() {
    echo "📦 Upgrading installed packages..."
    sudo apt upgrade -y
    if [ $? -eq 0 ]; then
        echo "✅ Installed updates successfully on $distro."
    else
        echo "❌ Failed to update packages on $distro. Exit code: $?"
    fi
}

dist_upgrade() {
    echo "📦 Upgrading distribution and dependencies..."
    sudo apt dist-upgrade -y
    if [ $? -eq 0 ]; then
        echo "✅ Upgraded distribution successfully."
    else
        echo "❌ Failed to upgrade $distro. Exit code: $?"
    fi
}

apt_autorm() {
    echo "🧹 Removing unnecessary packages..."
    sudo apt autoremove -y
    if [ $? -eq 0 ]; then
        echo "✅ Autoremove completed successfully on $distro."
    else
        echo "❌ Autoremove failed on $distro. Exit code: $?"
    fi
}

apt_autocls() {
    echo "🧼 Cleaning up local repository..."
    sudo apt autoclean -y
    if [ $? -eq 0 ]; then
        echo "✅ Autoclean completed successfully on $distro."
    else
        echo "❌ Autoclean failed on $distro. Exit code: $?"
    fi
}

install_package() {
    local package="$1"
    echo
    echo "📦 Installing package: $package"
    sudo apt install -y "$package"
    if [ $? -eq 0 ]; then
	echo "✅ $package installed successfully!"
    else
	echo "❌ Failed to install $package."
    fi
}

remove_package() {
    local package="$1"
    echo
    echo "📦 Removing package: $package"
    sudo apt remove -y "$package"
    if [ $? -eq 0 ]; then
        echo "✅ $package removed successfully!"
    else
        echo "❌ Failed to remove $package."
    fi
}

purge_package() {
    local package="$1"
    echo
    echo "📦 Purging package: $package"
    sudo apt purge -y "$package"
    if [ $? -eq 0 ]; then
        echo "✅ $package purged successfully!"
    else
        echo "❌ Failed to purge $package."
    fi
}

search_package() {
    local term="$1"
    echo "🔍 Searching for: $term"
    apt search "$term"
}


full_upgrade() {
    echo "⚙  Running full upgrade...!"
    apt_update && \
    apt_upgrade && \
    apt_autorm && \
    apt_autocls && \
    if [ $? -eq 0 ]; then
	echo "✅ Full upgrade completed successfully!"
    else
	echo "❌ An error occurred during the upgrade. Exit code: $?"
    fi
}

# Dev Automation
mv_robohelp() {
    sudo cp robohelp.sh /usr/local/bin/robohelp
}

find_playbook() {
    mapfile -t playbooks < <(find . -type f -name "*.yml")
    loop=-1
    for playbook in "${playbooks[@]}"; do
        ((loop++))
        dir_path=$(dirname "$playbook")
        file_name=$(basename "$playbook")
        printf '[%d] %s\n%s\n\n' "$loop" "$dir_path" "$file_name"
    done
}

check_if_flags() {
    echo ""
}

log_exists() {
    log_path="$HOME/.log/afmrun.log"
    if [ -f "$log_path" ]; then
        return 0
    else
	mkdir -p "$(dirname "$log_path")"
	touch "$log_path"
    fi
}

log_write() {
    case "$1" in
      "scs")
	echo "$timestamp - Successfully ran playbook: ${playbooks[$selected_index]}" >> "$log_path"
 	;;
      "ping")
	echo "$timestamp - Ping ran successfully" >> "$log_path"
	;;
      "fail")
	echo "$timestamp - Running playbook: ${playbooks[$selected_index]} failed" >> "$log_path"
	;;
    esac
}

log_actions() {
    log_exists && log_write "$1"
}


run_ping() {
    ansible all -m ping && log_actions "ping" || log_actions "fail"
}

run_playbook() {
    echo "What playbook would you like to run?"
    read -r selected_index
    check_if_flags
    ansible-playbook -i hosts.yml "${playbooks[$selected_index]}" --ask-become-pass -v && log_actions "scs" || log_actions "fail"
}

playbook_actions() {
# Is always executed
find_playbook

if [ "$1" = "run" ]; then
    run_playbook
fi

}

ansible_deploy() {
    check_installed "ansible" || exit 1

    echo
    echo "Welcome to the AFM - Ansible Fast Management"
    echo "What would you like to do?"
    echo
    echo "[1] Run Playbook (with Flags)"
    echo "[2] Test Connection (Ping Hosts)"
    echo "[3] View Inventory"
    echo "[4] View Last Run Log"
    echo "[5] Exit"
    echo

    read -r option

    if printf -- '%d' "${option}" > /dev/null 2>&1; then
	case "${option}" in
	    1)
		playbook_actions "run"
		;;
	    2)
		run_ping
		;;
	    3)
		playbook_actions
	        ;;
	    4)
                log_file="$HOME/.log/afmrun.log"

		if [ -f "$log_file" ]; then
		    echo
		    echo "📄 Showing Ansible log: $log_file"
		    echo
		    tail -n 50 "$log_file"
            	else
                    echo "⚠️  No Ansible log found at $log_file"
            	fi
                ;;
	    5)
                ;;
	    *)
		echo "Unsupported option"
		;;
	esac
    else
	echo "Unsupported option"
    fi
}

main() {
    show_banner
    det_release
    echo

	# Parse command-line flags
	case "$1" in
	    -aud|--apt-update)
		apt_update
		;;
	    -aur|--system-upgrade)
		apt_upgrade
		;;
	    -arm|--apt-autoremove)
		apt_autorm
		;;
	    -acl|--apt-autoclean)
		apt_autocls
		;;
	    -fu|--full-upgrade)
		full_upgrade
		;;
	    -dur|--dist-upgrade)
		dist_upgrade
		;;
	    -ai|--apt-install)
		shift
		if [ $# -eq 0 ]; then
		    echo "❌ No packages specified to install."
		    exit 1
		fi

		for package in "$@"; do
		    install_package "$package"
		done
		;;
	    -arp|--apt-remove)
		shift
		if [ $# -eq 0 ]; then
		    echo "❌ No packages specified to remove."
                    exit 1
		fi

		for package in "$@"; do
		    remove_package "$package"
		done
		;;
	    -ap|--apt-purge)
                shift
                if [ $# -eq 0 ]; then
                    echo "❌ No packages specified to purge."
                    exit 1
                fi

                for package in "$@"; do
                    purge_package "$package"
                done
                ;;
	    -as|--apt-search)
		shift
		if [ $# -eq 0 ]; then
		    echo "❌ No packages specified to search."
		    exit 1
		fi

		for term in "$@"; do
		    search_package "$term"
		done
		;;
	    -A|--ansible)
		ansible_deploy
		;;
	    -h|--help)
		echo
		echo "Usage: robohelp [option]"
		echo "	-aud, --apt-update	[1] Update APT Repositories"
		echo "	-aur, --apt-upgrade 	[1] Upgrade installed packages"
		echo "	-arm, --apt-autoremove  [1] Remove unnecessary packages"
		echo "	-acl, --apt-autoclean	[1] Clean up local repository"
		echo "	-fu,  --full-upgrade	Run full system upgrade with options from [1]"
		echo
		echo "	-dur, --dist-upgrade	Run distribution update for system"
		echo
		echo "	-ai,  --apt-install 	<name>	Install package via apt"
		echo "	-as,  --apt-search 	<name>	Search package in repository"
		echo " 	-arp, --apt-remove	<name>	Remove package from system"
		echo "	-ap,  --apt-purge	<name>	Remove package with all its dependencies"
		echo
		echo "	-A,   --ansible		Ansible Management"
		echo "	-h,   --help		Show this help message"
		;;
	    *)
		echo
		echo "Unknown or no flag provided. Try -h for help."
		;;
	esac
}

# Call the main function
main "$@"
